name: releaseãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
on:
  push:
    branches:
      - release/*

jobs:
  lint:
    runs-on: ubuntu-20.04

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_files
        run: |
          if ! git ls-files '*.go' '*.proto' | grep -q .; then
            echo "Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "skip_lint=true" >> $GITHUB_OUTPUT
          fi

      - name: Goã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.check_files.outputs.skip_lint != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'

      - name: Linterã‚’å®Ÿè¡Œ
        if: steps.check_files.outputs.skip_lint != 'true'
        run: |
          go get golang.org/x/lint/golint
          golint ./... | tee lint_report.txt
          if [ -s lint_report.txt ]; then
            echo "Lintã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            cat lint_report.txt
            exit 1
          fi

  test:
    runs-on: ubuntu-20.04
    needs: lint  # lintãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_files
        run: |
          if ! git ls-files '*.go' '*.proto' | grep -q .; then
            echo "Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "skip_test=true" >> $GITHUB_OUTPUT
          fi

      - name: Goã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.check_files.outputs.skip_test != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'

      - name: Tidy Go modules
        if: steps.check_files.outputs.skip_test != 'true'
        run: go mod tidy

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if: steps.check_files.outputs.skip_test != 'true'
        run: go test ./...

  create_pull_request:
    runs-on: ubuntu-20.04
    needs: test  # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Gitã®è¨­å®š
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        run: |
          # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚‹
          git fetch origin

          # æ—¢å­˜ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
          PR_NUMBER=$(gh pr list --base main --head "${{ github.ref_name }}" --json number -q '.[0].number')

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆ
          if [ -n "$PR_NUMBER" ]; then
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€æ›´æ–°ã—ã¾ã›ã‚“ã€‚"
            exit 0
          else
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æ–°ã—ã„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚"
            gh pr create \
              --base main \
              --head "${{ github.ref_name }}" \
              --label "release" \
              --title "ğŸ”€ Merge: releaseãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸" \
              --body "ğŸ”€ ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€releaseãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚" \
              --draft false
          fi

  tag:
    runs-on: ubuntu-20.04
    needs: create_pull_request  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ã‚¿ã‚°ã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v$(date +'%Y%m%d%H%M%S')"
          git tag $TAG_NAME
          git push origin $TAG_NAME
