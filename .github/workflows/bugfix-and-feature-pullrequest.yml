name: バグ修正と機能追加のプルリクエストをdevelopに作成

on:
  push:
    branches:
      - 'bugfix/*'
      - 'feature/*'

jobs:
  test:
    runs-on: ubuntu-20.04

    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Goまたはprotoファイルの存在をチェック
        id: check_files
        run: |
          if ! git ls-files '*.go' '*.proto' | grep -q .; then
            echo "Goまたはprotoファイルが見つからないためテストをスキップします。"
            echo "skip_test=true" >> $GITHUB_OUTPUT
          fi

      - name: Goのセットアップ
        if: steps.check_files.outputs.skip_test != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'

      - name: Tidy Go modules
        if: steps.check_files.outputs.skip_test != 'true'
        run: go mod tidy

      - name: テストを実行
        if: steps.check_files.outputs.skip_test != 'true'
        run: go test ./...

  create_pull_request:
    runs-on: ubuntu-20.04
    needs: test  # テストが成功した場合のみ実行
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Gitの設定
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      - name: プルリクエストを作成
        run: |
          # すべてのブランチをフェッチする
          git fetch origin

          # 既存のプルリクエストを取得する
          PR_NUMBER=$(gh pr list --base develop --head "${{ github.ref_name }}" --json number -q '.[0].number')

          # プルリクエストが存在する場合
          if [ -n "$PR_NUMBER" ]; then
            echo "プルリクエストが既に存在するため、更新しません。"
            exit 0
          else
            echo "プルリクエストが存在しないため、新しいプルリクエストを作成します。"
            # ブランチタイプに基づいてラベルとタイトルを設定
            if [[ "${{ github.ref }}" == *"bugfix/"* ]]; then
              LABEL="bugfix"
              TITLE="🐛 BugFix: ${GITHUB_REF#refs/heads/bugfix/}"
              BODY="🐛 このPRはバグ修正のためにbugfixワークフローによって自動的に作成されました。"
            else
              LABEL="enhancement"
              TITLE="✨ Feature: ${GITHUB_REF#refs/heads/feature/}"
              BODY="✨ このPRは機能追加のためにfeatureワークフローによって自動的に作成されました。"
            fi

            # 新しいプルリクエストを作成
            gh pr create \
              --base develop \
              --head "${{ github.ref_name }}" \
              --label "$LABEL" \
              --title "$TITLE" \
              --body "$BODY"
          fi
