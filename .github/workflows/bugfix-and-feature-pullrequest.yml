name: ãƒã‚°ä¿®æ­£ã¨æ©Ÿèƒ½è¿½åŠ ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’developã«ä½œæˆ

on:
  push:
    branches:
      - 'bugfix/*'
      - 'feature/*'

jobs:
  test:
    runs-on: ubuntu-20.04

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_files
        run: |
          if ! git ls-files '*.go' '*.proto' | grep -q .; then
            echo "Goã¾ãŸã¯protoãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "skip_test=true" >> $GITHUB_OUTPUT
          fi

      - name: Goã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.check_files.outputs.skip_test != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'

      - name: Tidy Go modules
        if: steps.check_files.outputs.skip_test != 'true'
        run: go mod tidy

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if: steps.check_files.outputs.skip_test != 'true'
        run: go test ./...

  create_pull_request:
    runs-on: ubuntu-20.04
    needs: test  # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Gitã®è¨­å®š
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        run: |
          # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚‹
          git fetch origin

          # æ—¢å­˜ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
          PR_NUMBER=$(gh pr list --base develop --head "${{ github.ref_name }}" --json number -q '.[0].number')

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆ
          if [ -n "$PR_NUMBER" ]; then
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€æ›´æ–°ã—ã¾ã›ã‚“ã€‚"
            exit 0
          else
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æ–°ã—ã„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚"
            # ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒ©ãƒ™ãƒ«ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
            if [[ "${{ github.ref }}" == *"bugfix/"* ]]; then
              LABEL="bugfix"
              TITLE="ğŸ› BugFix: ${GITHUB_REF#refs/heads/bugfix/}"
              BODY="ğŸ› ã“ã®PRã¯ãƒã‚°ä¿®æ­£ã®ãŸã‚ã«bugfixãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
            else
              LABEL="enhancement"
              TITLE="âœ¨ Feature: ${GITHUB_REF#refs/heads/feature/}"
              BODY="âœ¨ ã“ã®PRã¯æ©Ÿèƒ½è¿½åŠ ã®ãŸã‚ã«featureãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
            fi

            # æ–°ã—ã„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
            gh pr create \
              --base develop \
              --head "${{ github.ref_name }}" \
              --label "$LABEL" \
              --title "$TITLE" \
              --body "$BODY"
          fi
